
# 表达式

64位程序和32位程序的加、减、乘都差不多。32位程序的大数调用函数运算。

## 除法

**1.除数为无符号2的幂**
直接右移

**2.除数为有符号2的幂**
x < 0: (x + (2^n - 1)) >> n
``` masm
mov rax, rbx
cqo ; 符号位扩展
and edx, 2^n - 1
add rdx, rax
sar rdx, n
```

**3.除数为有符号-2的幂**
x < 0: -(x + (2^n - 1)) >> n

**4.除数为无符号非2的幂**
* 公式: x / c = x * 1/c = x * 2^n/2^n * 1/c = x * 2^n/c * 1/2^n
* 其中2^n/c可以提前计算, 这里叫 magic number 简称 M
* 所以 **x / c = x * M >> n** , 其中 M = 2^n/c
* c = 2^n / M

**5.除数为无符号非2的幂下, 上面的算法 M 溢出的情况, 变式**
* 公式: x / c =  (((x - (x * M >> 64)) >> n1) + (x * M >> 64)) >> n2
* 其中 M = 2^(64+n1+n2) / c - 2^64
* c = 2^(64+n1+n2) / (M + 2^64)

**6.除数为有符号非2的幂**
* 公式: x / c = (x * M >> n) + (x >> 63)
* M = 2^n/c
* c = 2^n / M

**7.除数为有符号非2的幂下**
* 公式: x / c = ((x * M >> 32) + x) >> n + (x >> 31)
* 32位值, M 会变成负数，所以有变式, 参考 32位反汇编代码
* 64位计算没有加法调整
* M = 2^n/c
* c = 2^n / M

**8.除数为有符号负非2的幂**
* 公式: x / -c = x * -2^n/c * 1/2^n = (x * M >> n) + (x >> 63)
* 其中 M 是负数
* M = -2^n/c = 0 - 2^n/c = neg(2^n/c) = 2^64 - 2^n/c
* c = 2^n / (2^64 - M)

**9.除数为有符号负非2的幂下**
* 公式: x / -c = ((x * M >> 32) - x) >> n + (x >> 31)
* 32位值, M 会变成正数，所以有变式, 参考 32位反汇编代码
* 64位计算没有减法调整