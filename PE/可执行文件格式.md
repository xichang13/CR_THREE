
# 可执行文件格式（Protable Excutable PE）

修改链接选项 `/ALIGN:#` 修改对齐值必须为4的倍数，默认512。`/MERGE:from=to` 合并段。

PE文件格式

# DOS头 （MZ） - C0 byte
* 寄存器初始化 40h byte

在位置 0x3c，存根具有 PE 签名文件偏移量。 此信息使 Windows 能够正确执行映像文件，即使此文件具有 MS-DOS 存根也不例外。 链接期间，此文件偏移量放在位置 0x3c。
* 签名（仅限映像）

MS-DOS 存根之后，在偏移量 0x3c 处指定的文件偏移处，是一个 4 字节签名，该签名将该文件标识为 PE 格式映像文件。 此签名为“PE\0\0”（字母“P”和“E”后跟两个 null 字节）。

* `push cs`
* `pop ds`
* `mov dx, e`
* `mov ah, 09`
* `int 21h`
* `mov ax, 4c01h`
* `int 21h`
* 字符串

结构体定义

```c
typedef struct _IMAGE_DOS_HEADER {      // DOS .EXE header
    WORD   e_magic;                     // Magic number
    WORD   e_cblp;                      // Bytes on last page of file
    WORD   e_cp;                        // Pages in file
    WORD   e_crlc;                      // Relocations
    WORD   e_cparhdr;                   // Size of header in paragraphs
    WORD   e_minalloc;                  // Minimum extra paragraphs needed
    WORD   e_maxalloc;                  // Maximum extra paragraphs needed
    WORD   e_ss;                        // Initial (relative) SS value
    WORD   e_sp;                        // Initial SP value
    WORD   e_csum;                      // Checksum
    WORD   e_ip;                        // Initial IP value
    WORD   e_cs;                        // Initial (relative) CS value
    WORD   e_lfarlc;                    // File address of relocation table
    WORD   e_ovno;                      // Overlay number
    WORD   e_res[4];                    // Reserved words
    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)
    WORD   e_oeminfo;                   // OEM information; e_oemid specific
    WORD   e_res2[10];                  // Reserved words
    LONG   e_lfanew;                    // File address of new exe header
  } IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```

dos 中间代码可以抹除或删除。

# PE头（PE Signature）

``` C
typedef struct _IMAGE_NT_HEADERS {
    DWORD Signature;                        // PE\0\0
    typedef struct _IMAGE_FILE_HEADER {
    WORD    Machine;                        //! 指令集
    WORD    NumberOfSections;               //! 节数量 代码和数据分区
    DWORD   TimeDateStamp;                  // 时间戳 编译时间 可以修改
    DWORD   PointerToSymbolTable;           // 符号表  可以修改
    DWORD   NumberOfSymbols;                // 符号表数量 可以修改
    WORD    SizeOfOptionalHeader;           //! 下一项 选项头大小 Optional header size
    WORD    Characteristics;                //! 文件属性
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
    typedef struct _IMAGE_OPTIONAL_HEADER {
    //
    // Standard fields.
    //

    WORD    Magic;                          
    BYTE    MajorLinkerVersion;
    BYTE    MinorLinkerVersion;
    DWORD   SizeOfCode;
    DWORD   SizeOfInitializedData;
    DWORD   SizeOfUninitializedData;
    DWORD   AddressOfEntryPoint;
    DWORD   BaseOfCode;
    DWORD   BaseOfData;

    //
    // NT additional fields.
    //

    DWORD   ImageBase;
    DWORD   SectionAlignment;
    DWORD   FileAlignment;
    WORD    MajorOperatingSystemVersion;
    WORD    MinorOperatingSystemVersion;
    WORD    MajorImageVersion;
    WORD    MinorImageVersion;
    WORD    MajorSubsystemVersion;
    WORD    MinorSubsystemVersion;
    DWORD   Win32VersionValue;
    DWORD   SizeOfImage;
    DWORD   SizeOfHeaders;
    DWORD   CheckSum;
    WORD    Subsystem;
    WORD    DllCharacteristics;
    DWORD   SizeOfStackReserve;
    DWORD   SizeOfStackCommit;
    DWORD   SizeOfHeapReserve;
    DWORD   SizeOfHeapCommit;
    DWORD   LoaderFlags;
    DWORD   NumberOfRvaAndSizes;
    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];
} IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;
```

# 节表（Section Headers）

结构体定义

``` C
typedef struct _IMAGE_SECTION_HEADER {
    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];
    union {
            DWORD   PhysicalAddress;
            DWORD   VirtualSize;
    } Misc;
    DWORD   VirtualAddress;
    DWORD   SizeOfRawData;
    DWORD   PointerToRawData;
    DWORD   PointerToRelocations;
    DWORD   PointerToLinenumbers;
    WORD    NumberOfRelocations;
    WORD    NumberOfLinenumbers;
    DWORD   Characteristics;
} IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;
```